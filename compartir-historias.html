<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compartir Historias - Silent Shores</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="imagenes/logo.jpg" type="image/jpeg">

<style>
    #usuario-actual {
        position: absolute;
        top: 10px;
        right: 20px;
        font-weight: bold;
        font-size: 1rem;
        background: #f0f0f0;
        padding: 4px 8px;
        border-radius: 8px;
    }
    .historia-card {
        background: #fff;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
</style>
</head>
<body>
<header style="position: relative;">
    <div class="logo">
        <img src="imagenes/logo.jpg" alt="Silent Shores Logo" class="logo-img">
        Silent Shores
    </div>
    <nav>
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="sobre-nosotros.html">Sobre Nosotros</a></li>
            <li><a href="compartir-historias.html">Compartir Historias</a></li>
            <li><a href="publicaciones.html">Publicaciones</a></li>
            <li><a href="contacto.html">Contacto</a></li>
        </ul>
    </nav>
    <button id="modo-toggle" class="modo-toggle">🌙 Modo Oscuro</button>
    <div id="usuario-actual"></div>
</header>

<main>
<section id="compartir-historias">
<h1>Comparte tu Historia</h1>
<p>Bienvenido al espacio donde puedes compartir tu experiencia y encontrar apoyo.</p>

<form id="historia-form">
    <label for="tipo-violencia">Selecciona el tipo de violencia:</label><br>
    <select id="tipo-violencia" name="tipo-violencia">
        <option value="Selecciona el tipo de violencia">Selecciona el tipo de violencia</option>
        <option value="Bullying">Bullying</option>
        <option value="Violencia Familiar">Violencia Familiar</option>
        <option value="Abuso Emocional">Abuso Emocional</option>
        <option value="Maltrato Físico">Maltrato Físico</option>
        <option value="Aislamiento Social">Aislamiento Social</option>
        <option value="Estrés y Ansiedad">Estrés y Ansiedad</option>
        <option value="Adicciones">Adicciones</option>
        <option value="Tristeza y Depresión">Tristeza y Depresión</option>
    </select><br>

    <label for="anonimo">¿Deseas enviar tu historia de forma anónima?</label><br>
    <input type="radio" id="anonimo" name="opcion" value="anonimo" checked>
    <label for="anonimo">Anónimo</label><br>
    <input type="radio" id="usuario" name="opcion" value="usuario">
    <label for="usuario">Con Usuario</label><br><br>

    <div id="usuario-container" style="display: none;">
        <label for="nombre-usuario">Nombre de Usuario:</label><br>
        <input type="text" id="nombre-usuario" name="nombre-usuario" placeholder="Introduce tu nombre de usuario"><br><br>
    </div>

    <textarea name="historia" id="historia" rows="10" placeholder="Escribe tu historia aquí..."></textarea><br><br>
    <button type="button" id="vista-previa-btn">Vista Previa</button>
</form>

<div id="vista-previa" style="display: none;">
    <h3>Vista Previa de la Historia</h3>
    <p><strong>Publicar como:</strong> <span id="publicar-como"></span></p>
    <p><strong>Tipo de violencia:</strong> <span id="tipo-violencia-preview"></span></p>
    <div id="historia-preview"></div>
    <button id="publicar-btn">Publicar Historia</button>
</div>

<hr>
<h2>📖 Historias compartidas</h2>
<div id="historias-container"></div>

</section>
</main>

<footer>
<div class="contacto-info">
    <p>Email: <a href="mailto:jessica@silentshores.com">jessica@silentshores.com</a></p>
    <p>Teléfono: <a href="tel:+51965775967">+51 965775967</a></p>
</div>
<div class="social-media">
    <p>Síguenos en:</p>
    <a href="#">Facebook</a>
    <a href="#">Twitter</a>
    <a href="#">Instagram</a>
</div>
<p>© 2025 Silent Shores. Todos los derechos reservados.</p>
</footer>

<script type="module">
    // =======================
    // 🔹 Firebase Config
    // =======================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBaFwwQTwrBtQ_BGf-Imp7FIY7dvkVo5Ho",
        authDomain: "silent-shores.firebaseapp.com",
        projectId: "silent-shores",
        storageBucket: "silent-shores.appspot.com",
        messagingSenderId: "300326009498",
        appId: "1:300326009498:web:b095642c0e7cfed7fcfd23"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =======================
    // 🔹 Sesión de usuario
    // =======================
    let usuarioActual = localStorage.getItem("usuarioActual");
    const usuarioDiv = document.getElementById("usuario-actual");

    if(!usuarioActual){
        usuarioDiv.innerHTML = `Usuario: Anónimo <button id="login-btn">Login</button>`;
        document.getElementById("login-btn").addEventListener("click", ()=>{
            const nombre = prompt("Ingresa tu nombre de usuario:");
            if(nombre && nombre.trim()!==""){
                localStorage.setItem("usuarioActual", nombre.trim());
                location.reload();
            }
        });
        usuarioActual = "Anónimo";
    } else {
        usuarioDiv.innerHTML = `Usuario: ${usuarioActual} <button id="logout-btn">Logout</button>`;
        document.getElementById("logout-btn").addEventListener("click", ()=>{
            localStorage.removeItem("usuarioActual");
            location.reload();
        });
    }

    // =======================
    // 🔹 Lógica del formulario
    // =======================
    const radioAnonimo = document.getElementById("anonimo");
    const radioUsuario = document.getElementById("usuario");
    const usuarioContainer = document.getElementById("usuario-container");
    const nombreUsuarioInput = document.getElementById("nombre-usuario");

    radioAnonimo.addEventListener("change", ()=> usuarioContainer.style.display="none");
    radioUsuario.addEventListener("change", ()=> {
        usuarioContainer.style.display="block";
        if(usuarioActual !== "Anónimo"){
            nombreUsuarioInput.value = usuarioActual;
        }
    });

    const vistaPreviaBtn = document.getElementById("vista-previa-btn");
    const historiaTextarea = document.getElementById("historia");
    const vistaPreviaDiv = document.getElementById("vista-previa");
    const publicarComo = document.getElementById("publicar-como");
    const historiaPreview = document.getElementById("historia-preview");
    const tipoViolenciaPreview = document.getElementById("tipo-violencia-preview");

    vistaPreviaBtn.addEventListener("click", ()=>{
        const opcion = document.querySelector('input[name="opcion"]:checked').value;
        const nombreUsuario = nombreUsuarioInput.value || usuarioActual;
        const tipoViolencia = document.getElementById("tipo-violencia").value;
        const nombreParaPublicar = opcion==="anonimo" ? "Anónimo" : `Usuario: ${nombreUsuario}`;
        publicarComo.textContent = nombreParaPublicar;
        historiaPreview.textContent = historiaTextarea.value;
        tipoViolenciaPreview.textContent = tipoViolencia;
        vistaPreviaDiv.style.display="block";
    });

    // =======================
    // 🔹 Publicar historia en Firestore
    // =======================
    const publicarBtn = document.getElementById("publicar-btn");
    const historiasContainer = document.getElementById("historias-container");

    publicarBtn.addEventListener("click", async ()=>{
        const historia = historiaTextarea.value;
        const opcion = document.querySelector('input[name="opcion"]:checked').value;
        const nombreUsuario = nombreUsuarioInput.value || usuarioActual;
        const tipoViolencia = document.getElementById("tipo-violencia").value;
        const nombreParaPublicar = opcion==="anonimo" ? "Anónimo" : `Usuario: ${nombreUsuario}`;

        if(historia.trim() === ""){
            alert("Por favor escribe tu historia antes de publicar.");
            return;
        }

        await addDoc(collection(db, "historias"), {
            nombre: nombreParaPublicar,
            historia: historia,
            tipoViolencia: tipoViolencia,
            fecha: new Date()
        });

        alert("¡Tu historia ha sido publicada!");
        historiaTextarea.value="";
        radioAnonimo.checked=true;
        usuarioContainer.style.display="none";
        vistaPreviaDiv.style.display="none";

        cargarHistorias();
    });

    // =======================
    // 🔹 Cargar historias desde Firestore
    // =======================
    async function cargarHistorias(){
        historiasContainer.innerHTML = "";
        const q = query(collection(db, "historias"), orderBy("fecha", "desc"));
        const querySnapshot = await getDocs(q);

        querySnapshot.forEach((doc)=>{
            const data = doc.data();
            const div = document.createElement("div");
            div.classList.add("historia-card");
            div.innerHTML = `
                <p><strong>${data.nombre}</strong> (${data.tipoViolencia})</p>
                <p>${data.historia}</p>
                <small>${new Date(data.fecha.seconds * 1000).toLocaleString()}</small>
            `;
            historiasContainer.appendChild(div);
        });
    }

    cargarHistorias();
</script>
</body>
</html>
